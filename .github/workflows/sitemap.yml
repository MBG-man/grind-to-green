name: Generate sitemap

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate sitemap.xml
        run: |
          echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > sitemap.xml
          echo "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> sitemap.xml

          # Homepage
          echo "<url><loc>https://grindtogreen.com/</loc></url>" >> sitemap.xml

          # Loop all JSON posts inside /posts/
          for file in posts/*.json; do
            filename=$(basename "$file" .json)
            echo "<url><loc>https://grindtogreen.com/posts/${filename}</loc></url>" >> sitemap.xml
          done

          echo "</urlset>" >> sitemap.xml

      - name: Commit sitemap.xml
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add sitemap.xml
          git commit -m "Update sitemap.xml" || echo "No changes to commit"
          git push
